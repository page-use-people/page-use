name: page-use

services:
  valkey:
    image: valkey/valkey:8.1.1
    restart: unless-stopped
    ports:
      - target: 6379
        published: 6667
        protocol: tcp
    volumes:
      - type: volume
        source: valkey-data
        target: /data

  postgres:
    image: postgres:17.4-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-postgres}"
      POSTGRES_DB: "${POSTGRES_DB:-page_use}"
    ports:
      - target: 5432
        published: 5433
    volumes:
      - type: volume
        source: postgres-data
        target: /var/lib/postgresql/data

  mono:
    build:
      context: .
      dockerfile: Dockerfile.mono
    restart: unless-stopped
    command: pnpm dev
    ports:
      - target: 12001
        published: "${CORE_PORT:-12001}"
      - target: 12002
        published: "${TODO_DEMO_PORT:-12002}"
      - target: 14001
        published: "${CORE_DEBUG_PORT:-14001}"
    environment:
      DATABASE_URL: "${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/page_use}"
      REDIS_URL: "${REDIS_URL:-redis://valkey:6379}"
      CORE_PORT: "${CORE_PORT:-12001}"
      NODE_ENV: "${NODE_ENV:-development}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-sk-ant-dummy-key-for-dev}"
      JWT_SIGNING_KEY: "${JWT_SIGNING_KEY:-dev-jwt-signing-key-not-for-production}"
      POSTHOG_API_KEY: "${POSTHOG_API_KEY:-phc_dummy_key_for_dev}"
    volumes:
      - type: bind
        source: .
        target: /app
    depends_on:
      - postgres
      - valkey

volumes:
  valkey-data:
  postgres-data:
